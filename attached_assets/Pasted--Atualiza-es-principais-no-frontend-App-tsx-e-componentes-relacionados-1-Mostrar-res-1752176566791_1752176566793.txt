// âœ… AtualizaÃ§Ãµes principais no frontend (App.tsx e componentes relacionados)

/*
1ï¸âƒ£ Mostrar resposta humanizada (em vez de JSON cru)
2ï¸âƒ£ Adicionar botÃ£o de upload de arquivos (aceitar .txt e .json)
3ï¸âƒ£ Manter botÃ£o "Testar ConexÃ£o" como ferramenta de diagnÃ³stico
*/

import React, { useState } from 'react';
import './App.css';

export default function App() {
  const [text, setText] = useState('');
  const [result, setResult] = useState('');
  const [status, setStatus] = useState('Aguardando texto do GuardiÃ£o...');
  const [isLoading, setIsLoading] = useState(false);

  // âœ… URL correta da API
  const API_URL = import.meta.env.VITE_API_URL || 'https://b70cbe73-5ac1-4669-ac5d-3129d59fb7a8-00-3ccdko9zwgzm3.riker.replit.dev/api/analyze';

  const handleSubmit = async () => {
    if (!text.trim()) {
      setResult('âš ï¸ Por favor, insira um texto para analisar.');
      return;
    }
    setIsLoading(true);
    setStatus('Processando anÃ¡lise com carinho...');
    try {
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text: text.trim() }),
      });
      const data = await response.json();
      if (data?.synthesis?.summary) {
        // âœ… Mostra apenas o resumo humanizado
        setResult(`âœ… Resumo: ${data.synthesis.summary}`);
      } else {
        setResult('âš ï¸ Resposta inesperada. Verifique o backend.');
      }
    } catch (error) {
      setResult(`Erro ao conectar: ${error instanceof Error ? error.message : String(error)}`);
    } finally {
      setIsLoading(false);
      setStatus('AnÃ¡lise concluÃ­da! Vamos revisar juntos?');
    }
  };

  // âœ… FunÃ§Ã£o para upload de arquivos (txt ou json)
  const handleFileUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
      const content = event.target?.result as string;
      setText(content);
    };

    if (file.type === 'application/json' || file.name.endsWith('.json')) {
      reader.readAsText(file);
    } else if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
      reader.readAsText(file);
    } else {
      setResult('âš ï¸ Tipo de arquivo nÃ£o suportado. Use .txt ou .json.');
    }
  };

  const handleTestConnection = async () => {
    setStatus('Testando conexÃ£o...');
    try {
      const response = await fetch(API_URL.replace('/analyze', '/status'));
      if (response.ok) {
        setResult('âœ… Backend respondeu corretamente!\n\nTeste realizado com sucesso.');
        setStatus('ConexÃ£o com backend funcionando!');
      } else {
        setResult(`âš ï¸ Backend retornou erro: ${response.status}`);
        setStatus('Erro na conexÃ£o com backend');
      }
    } catch (error) {
      setResult(`Erro ao testar conexÃ£o: ${error instanceof Error ? error.message : String(error)}`);
      setStatus('Erro na conexÃ£o com backend');
    }
  };

  return (
    <main>
      <h1>ğŸ’™ Saphira - AnÃ¡lise Inteligente</h1>
      <p>{status}</p>
      <textarea
        placeholder="Digite seu texto para anÃ¡lise com Saphira..."
        value={text}
        onChange={(e) => setText(e.target.value)}
      />
      <div className="button-group">
        <button onClick={handleSubmit} disabled={isLoading}>
          ğŸ” Analisar com Saphira
        </button>
        <button onClick={() => setText('')}>ğŸ§¹ Limpar</button>
        <button onClick={handleTestConnection}>ğŸ” Testar ConexÃ£o</button>
        <input
          type="file"
          accept=".txt,application/json"
          onChange={handleFileUpload}
          style={{ marginTop: '10px' }}
        />
      </div>
      <section className="result-area">
        <h3>ğŸ“‘ Resultado da AnÃ¡lise Saphira:</h3>
        <pre>{result}</pre>
      </section>
    </main>
  );
}
