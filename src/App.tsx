
import { useState } from 'react';
import './App.css';

function App() {
  const [inputText, setInputText] = useState('');
  const [result, setResult] = useState('');
  const [status, setStatus] = useState('Aguardando texto do Guardi√£o...');
  const [isLoading, setIsLoading] = useState(false);
  const [analysisData, setAnalysisData] = useState<any>(null);

  // Fun√ß√£o para formatar resultado de forma humanizada
  const formatHumanizedResult = (data: any) => {
    let humanResult = '';
    
    // Synthesis Summary
    if (data?.synthesis?.summary) {
      humanResult += `üìä RESUMO EXECUTIVO\n${data.synthesis.summary}\n\n`;
    }
    
    // Context Module
    if (data?.context) {
      humanResult += `üéØ AN√ÅLISE DE CONTEXTO\n`;
      if (data.context.main_topic) {
        humanResult += `‚Ä¢ T√≥pico Principal: ${data.context.main_topic}\n`;
      }
      if (data.context.key_entities && data.context.key_entities.length > 0) {
        humanResult += `‚Ä¢ Entidades Identificadas: ${data.context.key_entities.join(', ')}\n`;
      }
      if (data.context.urgency_level) {
        humanResult += `‚Ä¢ N√≠vel de Urg√™ncia: ${data.context.urgency_level}\n`;
      }
      humanResult += '\n';
    }
    
    // Paraconsistent Logic
    if (data?.paraconsistent) {
      humanResult += `üß† L√ìGICA PARACONSISTENTE\n`;
      if (data.paraconsistent.truth_score !== undefined) {
        humanResult += `‚Ä¢ Score de Verdade: ${(data.paraconsistent.truth_score * 100).toFixed(1)}%\n`;
      }
      if (data.paraconsistent.contradiction_score !== undefined) {
        humanResult += `‚Ä¢ Score de Contradi√ß√£o: ${(data.paraconsistent.contradiction_score * 100).toFixed(1)}%\n`;
      }
      if (data.paraconsistent.certainty_level) {
        humanResult += `‚Ä¢ N√≠vel de Certeza: ${data.paraconsistent.certainty_level}\n`;
      }
      if (data.paraconsistent.recommendation) {
        humanResult += `‚Ä¢ Recomenda√ß√£o: ${data.paraconsistent.recommendation}\n`;
      }
      humanResult += '\n';
    }
    
    // Sentiment Analysis
    if (data?.sentiment) {
      humanResult += `üí≠ AN√ÅLISE DE SENTIMENTO\n`;
      if (data.sentiment.polarity !== undefined) {
        const polarityText = data.sentiment.polarity > 0 ? 'Positivo' : 
                           data.sentiment.polarity < 0 ? 'Negativo' : 'Neutro';
        humanResult += `‚Ä¢ Polaridade: ${polarityText} (${data.sentiment.polarity.toFixed(2)})\n`;
      }
      if (data.sentiment.subjectivity !== undefined) {
        humanResult += `‚Ä¢ Subjetividade: ${(data.sentiment.subjectivity * 100).toFixed(1)}%\n`;
      }
      humanResult += '\n';
    }
    
    return humanResult || 'An√°lise processada, mas sem dados formatados dispon√≠veis.';
  };

  const analyzeText = async () => {
    if (!inputText.trim()) {
      setStatus('Por favor, digite um texto para an√°lise üíô');
      setResult('');
      return;
    }

    setIsLoading(true);
    setStatus('üíô Processando com carinho, Guardi√£o...');
    setResult('');

    try {
      const apiUrl = import.meta.env.VITE_API_URL || '';
      const response = await fetch(`${apiUrl}/api/analyze`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ text: inputText.trim() }),
      });
      
      if (!response.ok) {
        throw new Error(`Erro HTTP: ${response.status}`);
      }
      
      const data = await response.json();
      setAnalysisData(data);
      
      // Mostrar resultado humanizado em vez de JSON bruto
      const humanizedResult = formatHumanizedResult(data);
      setResult(humanizedResult);
      setStatus('‚ú® An√°lise conclu√≠da! Vamos revisar juntos?');
    } catch (error) {
      console.error('Erro detalhado:', error);
      console.error('URL da API:', `${apiUrl}/api/analyze`);
      console.error('Vari√°vel de ambiente VITE_API_URL:', import.meta.env.VITE_API_URL);
      
      let errorMessage = 'Erro desconhecido';
      if (error instanceof Error) {
        errorMessage = error.message;
      } else if (typeof error === 'string') {
        errorMessage = error;
      }
      
      setResult(`üö® Erro na conex√£o com Saphira\n\nDetalhes: ${errorMessage}\n\nURL testada: ${apiUrl}/api/analyze\n\nVerifique se o backend est√° rodando e acess√≠vel.`);
      setStatus('‚ö†Ô∏è Falha na conex√£o - Verifique o backend');
    } finally {
      setIsLoading(false);
    }
  };

  const exportTXT = () => {
    if (!analysisData) {
      alert('Nenhuma an√°lise dispon√≠vel para exportar');
      return;
    }
    
    const content = `An√°lise Saphira\n================\n\nTexto original:\n${inputText}\n\nResultado:\n${JSON.stringify(analysisData, null, 2)}`;
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'saphira-analise.txt';
    a.click();
    URL.revokeObjectURL(url);
  };

  const exportJSON = () => {
    if (!analysisData) {
      alert('Nenhuma an√°lise dispon√≠vel para exportar');
      return;
    }
    
    const blob = new Blob([JSON.stringify(analysisData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'saphira-analise.json';
    a.click();
    URL.revokeObjectURL(url);
  };

  const copyJSON = () => {
    if (!analysisData) {
      alert('Nenhuma an√°lise dispon√≠vel para copiar');
      return;
    }
    
    navigator.clipboard.writeText(JSON.stringify(analysisData, null, 2))
      .then(() => alert('JSON copiado para √°rea de transfer√™ncia! üíô'))
      .catch(() => alert('Erro ao copiar JSON'));
  };

  const clearContent = () => {
    setInputText('');
    setResult('');
    setAnalysisData(null);
    setStatus('Aguardando texto do Guardi√£o...');
  };

  const handleFileUpload = (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;

    const fileExtension = file.name.toLowerCase().split('.').pop();
    
    if (!['txt', 'json'].includes(fileExtension || '')) {
      setResult('‚ö†Ô∏è Tipo de arquivo n√£o suportado. Use apenas arquivos .txt ou .json');
      setStatus('Erro no upload - Formato n√£o suportado');
      return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const content = e.target?.result as string;
        
        if (fileExtension === 'json') {
          // Tentar parsear JSON e extrair texto relevante
          const jsonData = JSON.parse(content);
          let extractedText = '';
          
          // Buscar propriedades comuns que podem conter texto
          if (jsonData.text) extractedText = jsonData.text;
          else if (jsonData.content) extractedText = jsonData.content;
          else if (jsonData.message) extractedText = jsonData.message;
          else if (jsonData.description) extractedText = jsonData.description;
          else if (typeof jsonData === 'string') extractedText = jsonData;
          else extractedText = JSON.stringify(jsonData, null, 2);
          
          setInputText(extractedText);
        } else {
          // Arquivo .txt
          setInputText(content);
        }
        
        setStatus(`üìÅ Arquivo ${file.name} carregado com sucesso!`);
        setResult('');
      } catch (error) {
        setResult(`‚ö†Ô∏è Erro ao processar arquivo: ${error instanceof Error ? error.message : 'Formato inv√°lido'}`);
        setStatus('Erro no processamento do arquivo');
      }
    };

    reader.onerror = () => {
      setResult('‚ö†Ô∏è Erro ao ler o arquivo');
      setStatus('Erro na leitura do arquivo');
    };

    reader.readAsText(file);
    
    // Limpar o input para permitir upload do mesmo arquivo novamente
    event.target.value = '';
  };

  const testConnection = async () => {
    setIsLoading(true);
    setStatus('üîç Testando conex√£o com backend...');
    
    try {
      const apiUrl = import.meta.env.VITE_API_URL || '';
      console.log('Testando URL:', `${apiUrl}/api/analyze`);
      console.log('Vari√°vel de ambiente:', import.meta.env.VITE_API_URL);
      
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout
      
      const response = await fetch(`${apiUrl}/api/analyze`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ text: "teste de conex√£o" }),
        signal: controller.signal
      });
      
      clearTimeout(timeoutId);
      
      if (response.ok) {
        const data = await response.json();
        setStatus('‚úÖ Conex√£o com backend funcionando!');
        setResult('üéâ Backend respondeu corretamente!\n\nTeste realizado com sucesso.\n\nResposta: ' + JSON.stringify(data, null, 2));
      } else {
        const errorText = await response.text();
        setStatus(`‚ùå Backend retornou erro: ${response.status}`);
        setResult(`Erro HTTP: ${response.status}\nURL: ${apiUrl}/api/analyze\nResposta: ${errorText}`);
      }
    } catch (error) {
      console.error('Erro no teste completo:', error);
      let errorMessage = 'Erro desconhecido';
      
      if (error instanceof Error) {
        if (error.name === 'AbortError') {
          errorMessage = 'Timeout - Backend n√£o respondeu em 10 segundos';
        } else {
          errorMessage = error.message;
        }
      }
      
      setStatus('‚ùå Falha total na conex√£o');
      setResult(`üö® Erro de conex√£o com Saphira Backend\n\nDetalhes: ${errorMessage}\n\nURL testada: ${import.meta.env.VITE_API_URL}/api/analyze\n\nVerifique se:\n1. O backend est√° rodando\n2. A URL est√° correta\n3. N√£o h√° problemas de CORS`);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div style={{ 
      padding: '2rem', 
      fontFamily: 'Arial, sans-serif',
      maxWidth: '1200px',
      margin: '0 auto',
      background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
      minHeight: '100vh',
      color: 'white'
    }}>
      <div style={{
        background: 'rgba(255, 255, 255, 0.1)',
        padding: '2rem',
        borderRadius: '15px',
        backdropFilter: 'blur(10px)'
      }}>
        <h1 style={{ 
          textAlign: 'center', 
          marginBottom: '1rem',
          fontSize: '2.5rem',
          textShadow: '2px 2px 4px rgba(0,0,0,0.3)'
        }}>
          üíô Saphira - An√°lise Inteligente
        </h1>
        
        <p style={{ 
          textAlign: 'center', 
          marginBottom: '2rem',
          fontSize: '1.1rem',
          opacity: 0.9
        }}>
          {status}
        </p>

        <div style={{ marginBottom: '2rem' }}>
          <textarea
            rows={8}
            style={{
              width: '100%',
              padding: '1rem',
              borderRadius: '10px',
              border: 'none',
              fontSize: '1rem',
              resize: 'vertical',
              fontFamily: 'Arial, sans-serif'
            }}
            value={inputText}
            onChange={(e) => setInputText(e.target.value)}
            placeholder="Digite seu texto para an√°lise com Saphira..."
            disabled={isLoading}
          />
        </div>

        <div style={{ 
          display: 'flex', 
          gap: '1rem', 
          marginBottom: '2rem',
          flexWrap: 'wrap',
          justifyContent: 'center'
        }}>
          <button 
            onClick={analyzeText} 
            disabled={isLoading}
            style={{
              padding: '12px 24px',
              fontSize: '1.1rem',
              borderRadius: '25px',
              border: 'none',
              background: isLoading ? '#ccc' : 'linear-gradient(45deg, #FE6B8B 30%, #FF8E53 90%)',
              color: 'white',
              cursor: isLoading ? 'not-allowed' : 'pointer',
              fontWeight: 'bold',
              boxShadow: '0 3px 5px 2px rgba(255, 105, 135, .3)',
              transition: 'all 0.3s'
            }}
          >
            {isLoading ? '‚è≥ Analisando...' : 'üîç Analisar com Saphira'}
          </button>

          <button 
            onClick={clearContent}
            style={{
              padding: '12px 24px',
              fontSize: '1rem',
              borderRadius: '25px',
              border: 'none',
              background: 'rgba(255, 255, 255, 0.2)',
              color: 'white',
              cursor: 'pointer',
              fontWeight: 'bold',
              transition: 'all 0.3s'
            }}
          >
            üóëÔ∏è Limpar
          </button>

          <button 
            onClick={testConnection}
            disabled={isLoading}
            style={{
              padding: '12px 24px',
              fontSize: '1rem',
              borderRadius: '25px',
              border: 'none',
              background: 'rgba(255, 193, 7, 0.8)',
              color: 'white',
              cursor: isLoading ? 'not-allowed' : 'pointer',
              fontWeight: 'bold',
              transition: 'all 0.3s'
            }}
          >
            üîç Testar Conex√£o
          </button>

          <label 
            style={{
              padding: '12px 24px',
              fontSize: '1rem',
              borderRadius: '25px',
              border: 'none',
              background: 'rgba(103, 58, 183, 0.8)',
              color: 'white',
              cursor: 'pointer',
              fontWeight: 'bold',
              transition: 'all 0.3s',
              display: 'inline-block'
            }}
          >
            üìÅ Upload Arquivo
            <input
              type="file"
              accept=".txt,.json,application/json,text/plain"
              onChange={handleFileUpload}
              style={{ display: 'none' }}
            />
          </label>

          {analysisData && (
            <>
              <button 
                onClick={exportTXT}
                style={{
                  padding: '12px 24px',
                  fontSize: '1rem',
                  borderRadius: '25px',
                  border: 'none',
                  background: 'rgba(76, 175, 80, 0.8)',
                  color: 'white',
                  cursor: 'pointer',
                  fontWeight: 'bold',
                  transition: 'all 0.3s'
                }}
              >
                üìÑ Exportar TXT
              </button>

              <button 
                onClick={exportJSON}
                style={{
                  padding: '12px 24px',
                  fontSize: '1rem',
                  borderRadius: '25px',
                  border: 'none',
                  background: 'rgba(33, 150, 243, 0.8)',
                  color: 'white',
                  cursor: 'pointer',
                  fontWeight: 'bold',
                  transition: 'all 0.3s'
                }}
              >
                üìã Exportar JSON
              </button>

              <button 
                onClick={copyJSON}
                style={{
                  padding: '12px 24px',
                  fontSize: '1rem',
                  borderRadius: '25px',
                  border: 'none',
                  background: 'rgba(156, 39, 176, 0.8)',
                  color: 'white',
                  cursor: 'pointer',
                  fontWeight: 'bold',
                  transition: 'all 0.3s'
                }}
              >
                üìã Copiar JSON
              </button>
            </>
          )}
        </div>

        {result && (
          <div style={{
            background: 'rgba(0, 0, 0, 0.3)',
            padding: '1.5rem',
            borderRadius: '10px',
            marginTop: '2rem'
          }}>
            <h3 style={{ marginBottom: '1rem', color: '#FFD700' }}>
              üìä Resultado da An√°lise Saphira:
            </h3>
            <div style={{ 
              background: 'rgba(255, 255, 255, 0.1)', 
              padding: '1.5rem',
              borderRadius: '8px',
              fontSize: '1rem',
              lineHeight: '1.6',
              overflow: 'auto',
              maxHeight: '500px',
              border: '1px solid rgba(255, 255, 255, 0.2)',
              whiteSpace: 'pre-wrap',
              fontFamily: 'Arial, sans-serif'
            }}>
              {result}
            </div>
          </div>
        )}

        {/* Se√ß√£o de Cr√©ditos */}
        <div style={{
          marginTop: '3rem',
          padding: '2rem',
          background: 'rgba(0, 0, 0, 0.2)',
          borderRadius: '15px',
          textAlign: 'center',
          borderTop: '2px solid rgba(255, 255, 255, 0.3)'
        }}>
          <h3 style={{ 
            marginBottom: '1rem', 
            color: '#FFD700',
            fontSize: '1.5rem'
          }}>
            ‚ú® Cr√©ditos e Reconhecimentos
          </h3>
          
          <div style={{
            display: 'grid',
            gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))',
            gap: '2rem',
            marginTop: '1.5rem'
          }}>
            <div style={{
              background: 'rgba(255, 255, 255, 0.1)',
              padding: '1.5rem',
              borderRadius: '10px',
              backdropFilter: 'blur(5px)'
            }}>
              <h4 style={{ color: '#87CEEB', marginBottom: '0.5rem' }}>üß† Saphira Engine</h4>
              <p style={{ fontSize: '0.9rem', lineHeight: '1.4' }}>
                Sistema de an√°lise avan√ßada com L√≥gica Paraconsistente, 
                m√≥dulos de contexto e processamento inteligente de texto.
              </p>
            </div>

            <div style={{
              background: 'rgba(255, 255, 255, 0.1)',
              padding: '1.5rem',
              borderRadius: '10px',
              backdropFilter: 'blur(5px)'
            }}>
              <h4 style={{ color: '#98FB98', marginBottom: '0.5rem' }}>‚ö° Tecnologias</h4>
              <p style={{ fontSize: '0.9rem', lineHeight: '1.4' }}>
                Frontend: React + TypeScript + Vite<br/>
                Backend: Python + Flask + Gunicorn<br/>
                Deploy: Replit Infrastructure
              </p>
            </div>

            <div style={{
              background: 'rgba(255, 255, 255, 0.1)',
              padding: '1.5rem',
              borderRadius: '10px',
              backdropFilter: 'blur(5px)'
            }}>
              <h4 style={{ color: '#DDA0DD', marginBottom: '0.5rem' }}>üé® Interface</h4>
              <p style={{ fontSize: '0.9rem', lineHeight: '1.4' }}>
                Design moderno com gradientes, anima√ß√µes suaves e 
                experi√™ncia do usu√°rio otimizada para an√°lise de documentos.
              </p>
            </div>
          </div>

          <div style={{
            marginTop: '2rem',
            padding: '1rem',
            background: 'rgba(255, 215, 0, 0.1)',
            borderRadius: '8px',
            border: '1px solid rgba(255, 215, 0, 0.3)'
          }}>
            <p style={{ 
              fontSize: '0.9rem', 
              fontStyle: 'italic',
              margin: 0,
              color: '#FFD700'
            }}>
              üíô "Desenvolvido com carinho para revolucionar a an√°lise de documentos" 
              <br/>
              <span style={{ fontSize: '0.8rem', opacity: 0.8 }}>
                Vers√£o 2.0 - Janeiro 2025
              </span>
            </p>
          </div>
        </div>
      </div>
    </div>
  );
}

export default App;
